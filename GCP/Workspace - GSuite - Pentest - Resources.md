# Workspace - GSuite - Pentest - Resources

Google Workspace provide IdaaS (Identity As A Service) and SaaS (Software As A Service) throught its services such as Gmail, Drive ...   

When using organization level within GCP, you will use Google WorkSpace as Idaas.  

--> Overview of [Google Identity Management](https://cloud.google.com/architecture/identity/overview-google-authentication)

Workspace also know as Gsuite:
- Gmail
- Google Drive
- Google Contacts
- Google Calendar, Meet ...

**User Portal URL** : https://myaccount.google.com/  
**User API Endpoint** : https://[service-name].googleapis.com  

Workspace Portal and API is only available for admin.
- Portal URL : https://admin.google.com
- Admin API Endpoint : https://admin.googleapis.com

**Directory**: Workspace directory is a container which contains information about users, groups and organizations units of an organization.  

### Admin Role
Admin role are mainly used to managed Google Workspace, users/groups, devices, role management and manage workspace services such as Gmail and other services settings.  

**2** Admin role types:
- Pre-build administrator roles
  - Super Admin
  - Groups Admin
  - Help Desk Admin
  - Services Admin
  - Storage Admin 
  - ... etc
  
- Custom admin roles

--> Admin roles can be assigned to **user account** and **service account**. (Except **Super Admin** role)  

Role contains 2 types of privileges:
- Admin console privileges
- Admin API privileges

--> **Only Super Admin can assign admin roles** to another user / service account.  

## Phishing
Phising G-Suite:
• Calendar Event Injection
• Silently injects events to target calendars
• No email required
• Google API allows to mark as accepted
• Bypasses the “don’t auto-add” setting
• Creates urgency w/ reminder notification
• Include link to phishing page

## Initial Access

## Analysis
#### Gsuite cartography
Enumerate and graph Google GSuite - users, groups.  
- https://github.com/lyft/cartography
- https://lyft.github.io/cartography/modules/gsuite/index.html

## Lateral movement
### Domain Wide Delegation
Domain Wide Delegation allow some service account to access Google Workspace data such as Gmail, Drive and others. Initially design to allows apps to access users' data across your organization's Google Workspace environment.  

- https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/-/blob/master/gcp_delegation.py?ref_type=heads

```
./gcp_delegation.py --keyfile ./credentials.json --impersonate steve.admin@target-org.com --domain target-org.com --list
```

## Exfiltration
#### Dumping Google Workspace Directory
- https://github.com/RedTeamOperations/GoogleWorkspaceDirectoryDump

## Defense / Monitoring
#### Audit logs - Google Workspace
Google Cloud services write audit logs that record administrative activities and accesses within your Google Workspace.

Different type of audit Logs in Google Workspace :
1. Admin Audit logs
  - Activity
  - Data Access
2. Enterprise Groups Audit logs
3. Login Audit logs
4. OAuth Token Audit logs
5. SAML Audit logs

- https://admin.google.com/u/0/ac/sc/investigation?ref=reporting

## Resources
#### Workspace Pentesting
- https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security

#### GSuite Red teaming phishing using google groups
- https://systemweakness.com/gsuite-red-teaming-phishing-using-google-groups-924901e574c2

#### GSuite Red teaming phishing using google chat
- https://systemweakness.com/gsuite-red-teaming-google-chat-phishing-ruse-50ba430b170a